<!doctype HTML>
<html>
<script src="https://aframe.io/releases/0.7.1/aframe.min.js"></script>
<script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.6.0/aframe/build/aframe-ar.js"> </script>
<script src="js/interact.js"></script>
<script src="js/tingle.js"></script>
<script src="js/vue.js"></script>
<script src="js/vue-3d-model.min.js"></script>
<link rel="stylesheet" type="text/css" href="./css/clues.css">
<link rel="stylesheet" type="text/css" href="./css/scene.css">
<link rel="stylesheet" type="text/css" href="./css/tingle.css">
<link href="https://fonts.googleapis.com/css?family=Merriweather" rel="stylesheet">

<script src="js/typewriter.js"></script>
<script src="js/intro.js"> </script>
<link rel="stylesheet" type="text/css" href="./css/introjs.css">

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

<!-- <link rel="stylesheet" type="text/css" href="css/public.css"> -->
<link rel="stylesheet" type="text/css" href="css/mobileSelect.css">
<script src="js/mobileSelect.js" type="text/javascript"></script>


<body style='margin : 0px; overflow: hidden;'>
	<a-scene id="ascene" embedded arjs="debugUIEnabled: false; patternRatio: 0.8">

		<a-entity camera></a-entity>
		<a-entity cursor="fuse: true; fuseTimout: 3000" position="0 0 -1" scale="0.01 0.01 0.01" geometry="primitive: ring" material="color: black; shader: flat">
		</a-entity>

	</a-scene>

	<button id="btn-clues" class="overlay tingle-btn tingle-btn--primary tutorial-click" onclick="toggleClues()">Clues</button>
	<button id="btn-models" class="overlay tingle-btn tingle-btn--primary tutorial-click" onclick="toggleModels()">Models</button>
	<button id="btn-characters" class="overlay tingle-btn tingle-btn--primary tutorial-click" data-toggle="modal" data-target="#characterModal">Characters</button>

	<div id="app" class="grayBg">
		<div id="clues" class="grayBg"></div>
		<br>
		<div id="revelations" class="grayBg"></div>
	</div>

	<div id="cursorTutorial" data-step="1" data-intro="This is the cursor. Use it to aim markers and click to interact with clues."></div>

	<div id="models" class='grayBg'>
		<iframe src="models-viewer.html" id="modelsframe"></iframe>
	</div>


	<div id="mobileTrig" style="visibility: hidden;">
	</div>

	<div id="preload">
		<img src="img/dhdtective.png" width="1" height="1" alt="Image 01" />
	</div>


	<!-- Modal -->
	<div id="characterModal" class="modal fade" role="dialog">
		<div class="modal-dialog grayBg">

			<!-- Modal content-->
			<div class="modal-content grayBg">
				<div class="modal-header">
					<button type="button" class="close modalContents" data-dismiss="modal">&times;</button>
					<h2 class="modal-title">The faces behind the story</h2>
				</div>
				<div id="characterModalBody" class="modal-body">
					<!--<input id='lindamurri' class='pngBtn' type='image' src = './img/lm.svg' onclick="addCharacter('lindamurri')"/>-->
				</div>
				<div id="characterModalFooter" class="modal-footer">
					<div id="description"></div>
				</div>
			</div>
		</div>

	</div>

	<div id="interrogationModal" class="modal fade" role="dialog">
		<div class="modal-dialog grayBg">

			<!-- Modal content-->
			<div class="modal-content grayBg">
				<div class="modal-header">
					<button type="button" class="close modalContents" data-dismiss="modal">&times;</button>
					<h2 class="modal-title" align="center">Interrogation</h2>
				</div>
				<div id="interrogationModalBody" class="modal-body">
					<!--<input id='lindamurri' class='pngBtn' type='image' src = './img/lm.svg' onclick="addCharacter('lindamurri')"/>-->
				</div>
				<div id="interrogationModalFooter" class="modal-footer">
					<p>Question:</p>
					<select class="form-control" id="questions">

					</select>
					</br>
					<button id="ask" type="button" class="btn btn-default"> Ask </button>
				</div>
			</div>
		</div>
	</div>
	<div id="imageModal" class="modal fade" role="dialog">
		<div class="modal-dialog grayBg">

			<!-- Modal content-->
			<div class="modal-content grayBg">
				<div class="modal-header">
					<button type="button" class="close modalContents" data-dismiss="modal">&times;</button>
					<h2 class="modal-title">Object found..</h2>
				</div>
				<div id="imageModalBody" class="modal-body">
					<div id='imageModalImg'>

					</div>
					<!--<input id='lindamurri' class='pngBtn' type='image' src = './img/lm.svg' onclick="addCharacter('lindamurri')"/>-->
					<div id='imgDescription'> 
					</div>
				</div>
				<div id="imageModalFooter" class="modal-footer">
					<button id="nextImg" type="button" class="btn btn-default"> Next </button>
				</div>
			</div>
		</div>
	</div>
	<div id="aysModal" class="modal fade" role="dialog">
		<div class="modal-dialog grayBg">

			<!-- Modal content-->
			<div class="modal-content grayBg">
				<div class="modal-header">
					<button type="button" class="close modalContents" data-dismiss="modal">&times;</button>
				</div>
				<div id="aysModalBody" class="modal-body">
					<!--<input id='lindamurri' class='pngBtn' type='image' src = './img/lm.svg' onclick="addCharacter('lindamurri')"/>-->
				</div>
				<div id="aysModalFooter" class="modal-footer" align="center">
					<button id="noBtn" type="button" class="btn btn-default" data-dismiss="modal"> <span class="glyphicon glyphicon-remove"></span> </button>
					<button id="yesBtn" type="button" class="btn btn-default "> <span class="glyphicon glyphicon-ok"></span> </button>
				</div>
			</div>

		</div>
	</div>


	<script src="gamedata.json"></script>
	<script src="characters.json"></script>
	<script src="foundImages.json"></script>
	<script>

		var alreadyAddedClues = [];
		var scrollToY = 0;

		function initCharacters() {
			for (i = 0; i < characters.length; i++) {
				$('#characterModalBody').append("<input id='" + characters[i].id + "' class='pngBtn modalContents' type='image' src='./img/StoriaIniziale/" + characters[i].image + "' onclick='addCharacter(\"" + characters[i].id + "\")' />");
				if (i == 2)
					$('#characterModalBody').append("</br>");
			}
			console.log("added")
		}

		/* Toggles the Clues/Revelation interface visibility */
		function toggleClues() {
			if (!cluesVisible) {
				if (modelsVisible) {
					document.getElementById('models').style.visibility = "hidden";
					modelsVisible = false;
				}

				document.getElementById('app').style.visibility = "visible";
				$('#revelations').scrollTop(scrollToY);

				if (tutorialClues) {
					document.getElementById('clues').setAttribute('data-step', "1");
					document.getElementById('clues').setAttribute('data-intro', "Here you can find all the discovered clues. Drag them to the revelation zone to go on with the investigation.");

					document.getElementById('revelations').setAttribute('data-step', "2");
					document.getElementById('revelations').setAttribute('data-intro', "This is the revelation zone. Fill the gaps with the right clues...");

					document.getElementById('btn-clues').removeAttribute('data-step');
					document.getElementById('btn-clues').removeAttribute('data-intro');

					//document.getElementById('btn-models').removeAttribute('data-step');
					//document.getElementById('btn-models').removeAttribute('data-intro');

					document.getElementById('btn-characters').removeAttribute('data-step');
					document.getElementById('btn-characters').removeAttribute('data-intro');

					tutorialClues = false;

					introJs().start();
				}
			}
			else {
				document.getElementById('app').style.visibility = "hidden";
			}
			cluesVisible = !cluesVisible;
		}

		/* Toggles the Models interface visibility */
		function toggleModels() {
			if (!modelsVisible) {
				if (cluesVisible) {
					document.getElementById('app').style.visibility = "hidden";
					cluesVisible = false;
				}
				document.getElementById('models').style.visibility = "visible";
			}
			else {
				document.getElementById('models').style.visibility = "hidden";
			}
			modelsVisible = !modelsVisible;
		}


		/* Add the HTML code related to a clue */
		function addClueSetup(id) {
			document.getElementById('clues').innerHTML += '<div id="' + id + '" class="draggable-clue" align="center" dropped="false"> <image class="clueImg"  src = "./iconselect/images/icons/' + id + '.png" ></image> </div>';
			var coords = interact.getElementRect(document.getElementById(id));
			cluePositions.list.push({ x: coords.left + coords.width / 2, y: coords.top + coords.height / 2 })
		}


		/* Add the HTML code related to a clue */
		function addClue(id) {
			console.log("Adding clue: " + id);
			if (alreadyAddedClues.indexOf(id) == -1) {
				//document.getElementById('clues').innerHTML += '<div id="' + id + '" class="draggable-clue" align="center" dropped="false"> <span class="glyphicon glyphicon-'+id+'"></span> </div>';  
				document.getElementById('clues').innerHTML += '<div id="' + id + '" class="draggable draggable-clue" align="center" dropped="false"><image class="clueImg"  src = "./iconselect/images/icons/' + id + '.png" ></image></div>';
				alreadyAddedClues.push(id);
				cluePositions.size++;
				activateDraggableClueById(id, cluePositions.size - 1);

				$('#btn-clues').addClass('active');
				setTimeout(function () {
					$('body, button').removeClass('active');
				}, 1200);

				/* Models */
				if (discovered[id] == null) {
					discovered[id] = true;
					for (var i = 0; i < gameData.clues.length; i++) {
						if (gameData.clues[i].id == id) {
							if (gameData.clues[i].showModel)
								addModel(id);
								return;
						}
					}
				}
			}

		}
		/* Add character description */
		function addCharacter(id) {
			for (i = 0; i < characters.length; i++) {
				if (characters[i].id == id) {
					break;
				}
			}
			console.log(id);
			cont = '';
			cont += '<h2 class="modalContents">' + characters[i].name + '</h2><h4><i>' + characters[i].intro + '</i></h4> <h3 class="modalContents">';
			characters[i].description.forEach(function (el) {
				cont += el + '</br>';
			});
			cont += '</h3><div align="center"><image class="charImg modalContens"  src="./img/Interrogatorio/' + characters[i].image + '">'
			cont += '</br><hr><button id="interrogation" type ="button"  class="btn btn-default"'
			if (chapterIndex < 4) cont += 'disabled' //TODO rimettere 4, mettere 1 per gli esperimenti
			cont += ' onclick ="interrogate(' + i + ')"> Start interrogation </button>'
			if (questionStep >= 3 && characters[i].name != 'Francesco Bonmartini' && lastQuestions['lindamurri'] && lastQuestions['augustomurri'] && lastQuestions['TullioMurri']) {
				cont += '<button id="accuse" type="button" class="btn btn-default" onclick ="accuse(' + i + ')"> Accuse </button>'
			}
			cont += '</div>'
			$('#description').html(cont);
			if (characters[i].name == "Francesco Bonmartini")
				$('#interrogation').hide();
			else
				$('#interrogation').show();
		}
		/* Create next chapter revelation */
		function addChapterRevelation() {
			addRevelation(
				"Chapter " + gameData.revelations[chapterIndex].number + " - " + gameData.revelations[chapterIndex].title,
				gameData.revelations[chapterIndex].id,
				gameData.revelations[chapterIndex].clueList
			);
			scrollToY += $('.revelation:last').height();
			console.log('---' + scrollToY)

		}


		/* Add the HTML code related to a revelation */
		function addRevelation(name, id, clueIdList) {
			revCode = '<div id="' + id + '"class="revelation">';
			revCode += '<h4>' + name + '</h4>';
			revCode += '<div class="dropzones">';
			for (var i = 0; i < clueIdList.length; i++) {
				revCode += '<div id="' + id + '-' + i + '" class="dropzone outer-dropzone"></div>'
			}
			revCode += '</div>';
			revCode += '</div>';
			document.getElementById('revelations').innerHTML += revCode;
		}

		function viewImage(id) {
			console.log('prima');
			$('#imageModal').modal("show");
			console.log('dopo');
			this.populateImgModal(0, id);
		}

		function populateImgModal(i, id) {
			console.log('dentro populate')
			if (i < foundImages[id].length) {
				var cont = '<img class="detective-img" src = "' + foundImages[id][i].img + '" />'
				$('#imageModalImg').html(cont);
				var cont = '<h3>' + foundImages[id][i].subtitle + '</h3><hr>';
				cont += '<h4>' + foundImages[id][i].description + '</h4>';
				$('#imgDescription').html(cont);
				j= i+1;
				$("#nextImg").attr("onclick", "populateImgModal(" + j + ", \"" + id + "\")");
			}
			else {
				$('#imageModal').modal("hide");
			}
		}


		/* Interact.js code to make the clues div draggable */
		function activateDraggableClues() {

			// target elements with the "draggable-clue" class
			interact('.draggable')
				.draggable({
					snap: {
						targets: [startPos],
						range: Infinity,
						relativePoints: [{ x: 0.5, y: 0.5 }],
						endOnly: true
					},
					inertia: true,
					restrict: {
						restriction: "#app",
						endOnly: false,
						elementRect: { top: 0.1, left: 0.1, bottom: 0.9, right: 0.9 }
					},
					autoScroll: false,

					onstart: function (event) {

						var rect = interact.getElementRect(event.target);
						startPos.x = rect.left + rect.width / 2;
						startPos.y = rect.top + + rect.height / 2;

						if (event.target.toTransform == false) {
							var par = interact.getElementRect(event.target.parentNode);
							startPos.x = par.left + par.width / 2;
							startPos.y = par.top + + par.height / 2;

							event.target.toTransform = true;
						}

						event.target.setAttribute('data-start-x', rect.left + rect.width / 2);
						event.target.setAttribute('data-start-y', rect.top + rect.height / 2);

						event.interactable.draggable({
							snap: {
								targets: [startPos]
							}
						});
					},

					onmove: dragMoveListener,

					onend: function (event) {
						/*console.log(startPos);
						// snap to the start position
						event.interactable.draggable({
							snap: {
								targets: [startPos]
							}
						});*/
					}
				});

		}


		/* Interact.js code to make the clues div draggable */
		function activateDraggableClueById(id, posIndex) {

			// target elements with the "draggable-clue" class
			interact('#' + id)
				.draggable({
					snap: {
						targets: [cluePositions.list[posIndex]],
						range: Infinity,
						relativePoints: [{ x: 0.5, y: 0.5 }],
						endOnly: true
					},

				});

		}



		/* Listener for moving objects */
		function dragMoveListener(event) {
			var target = event.target,
				// keep the dragged position in the data-x/data-y attributes
				x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
				y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

			// translate the element
			if (target.toTransform != false)
				target.style.webkitTransform =
					target.style.transform =
					'translate(' + x + 'px, ' + y + 'px)';

			// update the position attributes
			target.setAttribute('data-x', x);
			target.setAttribute('data-y', y);
		}


		function activateDropzones() {
			// enable draggables to be dropped into this
			interact('.dropzone').dropzone({
				accept: '.draggable-clue',
				// Require a 75% element overlap for a drop to be possible
				overlap: 0.75,

				// listen for drop related events:
				ondropactivate: function (event) {
					// add active dropzone feedback
					event.target.classList.add('drop-active');
				},
				ondragenter: function (event) {
					var draggableElement = event.relatedTarget,
						dropzoneElement = event.target;


					if (dropzoneElement.getAttribute('content') == null) {

						cluePositions.size--;

						dropzoneElement.setAttribute('content', draggableElement.id);
						// feedback the possibility of a drop
						dropzoneElement.classList.add('drop-target');
						draggableElement.classList.add('can-drop');

						var draggableElement = event.relatedTarget,
							dropzoneElement = event.target,
							dropRect = interact.getElementRect(dropzoneElement),
							dropCenter = {
								x: dropRect.left + dropRect.width / 2,
								y: dropRect.top + dropRect.height / 2
							};

						event.draggable.draggable({
							snap: {
								targets: [dropCenter]
							}
						});
					}
				},
				ondragleave: function (event) {
					event.relatedTarget.classList.remove('can-drop');

					if (event.relatedTarget.id == event.target.getAttribute('content')) {
						event.target.removeAttribute('content');

						var par = interact.getElementRect(event.target);

						// remove the drop feedback style
						event.target.classList.remove('drop-target');
						event.target.classList.remove('drop-content');

						cluePositions.size++;


						if (event.relatedTarget.getAttribute('dropped') == "true") {

							event.relatedTarget.classList.remove('dropped');
							event.relatedTarget.parentNode.removeChild(event.relatedTarget);
							document.getElementById('clues').appendChild(event.relatedTarget);

							var rect = interact.getElementRect(event.relatedTarget);

							event.relatedTarget.setAttribute('data-start-x', cluePositions.list[cluePositions.size - 1].x - 0 * rect.width);
							event.relatedTarget.setAttribute('data-start-y', cluePositions.list[cluePositions.size - 1].y - 0 * rect.height);

							event.relatedTarget.setAttribute('data-x', parseFloat(event.relatedTarget.getAttribute('data-x')) + par.left + par.width / 2 - cluePositions.list[cluePositions.size - 1].x);
							event.relatedTarget.setAttribute('data-y', parseFloat(event.relatedTarget.getAttribute('data-y')) + par.top + par.height / 2 - cluePositions.list[cluePositions.size - 1].y);

							console.log("Setting snap to : " + cluePositions.list[cluePositions.size - 1].x + " " + cluePositions.list[cluePositions.size - 1].y);
							event.relatedTarget.setAttribute('dropped', false);
						}

						event.draggable.draggable({
							snap: {
								targets: [
									{
										x: parseFloat(event.relatedTarget.getAttribute('data-start-x')),
										y: parseFloat(event.relatedTarget.getAttribute('data-start-y'))
									}
								]
							}
						});
					}



				},
				ondrop: function (event) {
					event.target.classList.add('drop-content');
					event.target.appendChild(event.relatedTarget);

					event.relatedTarget.setAttribute('data-x', 0);
					event.relatedTarget.setAttribute('data-y', 0);
					event.relatedTarget.setAttribute('dropped', true);
					event.relatedTarget.classList.add('dropped');

					/* tutti i rimanenti aggiustati nella posizione */
					var cluesDiv = document.getElementById('clues');
					for (var i = 0; i < cluesDiv.children.length; i++) {
						activateDraggableClueById(cluesDiv.children[i].id, i);
					}

					event.relatedTarget.toTransform = false;
					event.relatedTarget.style.webkitTransform =
						event.relatedTarget.style.transform = 'translate(0px, 0px)';

					var parentEl = event.target.parentNode;
					var nodes = parentEl.childNodes;
					var content;
					var completed = true;
					var revelation = null;

					for (i = 0; i < gameData.revelations.length; i++) {
						if (gameData.revelations[i].id == parentEl.parentNode.id) {
							revelation = gameData.revelations[i];
						}
					}

					if (revelation == null) {
						return;
					}

					for (i = 0; i < nodes.length; i++) {
						content = nodes[i].getAttribute('content');
						if (revelation.clueList.indexOf(content) < 0) {
							completed = false;
							break;
						}
					}

					if (completed) {
						toggleClues();
						handleRevelationCompleted(revelation.id);
					}
				},
				ondropdeactivate: function (event) {
					// remove active dropzone feedback
					event.target.classList.remove('drop-active');
					event.target.classList.remove('drop-target');
				}
			});
		}


		/* Create initial modal */
		function createInitialModal() {
			// instanciate new modal
			var modal = new tingle.modal({
				footer: true,
				stickyFooter: false,
				closeMethods: ['button'],
				//closeLabel: "Close",
				cssClass: ['clickableModal'],
				onOpen: function () {
				},
				onClose: function () {
				},
				beforeClose: function () {
					return true; // close the modal
				}
			});

			// set content
			modal.setContent('<h1>' + gameData.initialDialog.title + '</h1>');

			// add a button
			modal.addFooterBtn('Start', 'tingle-btn tingle-btn--primary tingle-btn--pull-right', function () {
				modal.close();
				modal.destroy();
				createNewChapterModal(0);
			});

			// open modal
			modal.open();

			return modal;
		}



		function createNewChapterModal() {

			/* stepIndex is the dialog line number */
			var stepIndex = 0;
			var btnText = '';

			// instanciate new modal
			var modal = new tingle.modal({
				footer: true,
				stickyFooter: false,
				closeMethods: ['button'],
				//closeLabel: "Close",
				cssClass: [],
				onOpen: function () {
				},
				onClose: function () {
				},
				beforeClose: function () {
					return true; // close the modal
				}
			});

			// set content
			var content = "";
			//content += '<h2>Chapter ' + gameData.revelations[chapterIndex].number + ' - ' + gameData.revelations[chapterIndex].title + '</h2>';
			content += '<img class="detective-img" src="img/dhdtective.png"/>';
			content += '<p id="typewriter-text" class="dialog-text"></p>'
			modal.setContent(content);

			if (stepIndex == gameData.revelations[chapterIndex].intro.length - 1) {
				btnText = 'Ok';
			}
			else {
				btnText = 'Next';
			}

			// add a button
			modal.addFooterBtn(btnText, 'tingle-btn tingle-btn--primary tingle-btn--pull-right', function () {

				/* Start the chapter */
				if (stepIndex == gameData.revelations[chapterIndex].intro.length - 1) {
					modal.close();
					modal.destroy();
					setupChapterMarkers(chapterIndex);

					if (chapterIndex == 0) {
						introJs().start();
					}
				}


				/* Next dialog line */
				else {
					stepIndex++;

					typewriter.deleteAll()
						.pauseFor(500)
						.typeString(gameData.revelations[chapterIndex].intro[stepIndex])
						.pauseFor(500)
						.start();

					if (stepIndex == gameData.revelations[chapterIndex].intro.length - 1) {
						document.getElementsByClassName('tingle-btn--pull-right')[0].innerHTML = 'Ok';
					}
				}
			});

			// open modal
			modal.open();

			// Typewriter text animation
			var app = document.getElementById('typewriter-text');

			var typewriter = new Typewriter(app, {
				loop: false,
				typingSpeed: 40,
				deleteSpeed: 0.01
			});

			typewriter.pauseFor(500)
				.typeString(gameData.revelations[chapterIndex].intro[stepIndex])
				.pauseFor(500)
				.start();

			return modal;
		}

		function createChapterEndModal() {

			/* stepIndex is the dialog line number */
			var stepIndex = 0;
			var btnText = '';

			// instanciate new modal
			var modal = new tingle.modal({
				footer: true,
				stickyFooter: false,
				closeMethods: ['button'],
				//closeLabel: "Close",
				cssClass: [],
				onOpen: function () {
				},
				onClose: function () {
				},
				beforeClose: function () {
					return true; // close the modal
				}
			});

			if (stepIndex == gameData.revelations[chapterIndex].outro.length - 1) {
				btnText = 'Ok';
			}
			else {
				btnText = 'Next';
			}

			// set content
			// set content
			var content = "";
			//content += '<h2>Chapter ' + gameData.revelations[chapterIndex].number + ' - ' + gameData.revelations[chapterIndex].title + '</h2>';
			content += '<img class="detective-img" src="img/dhdtective.png"/>';
			content += '<p id="typewriter-text" class="dialog-text"></p>'
			modal.setContent(content);

			// add a button
			modal.addFooterBtn(btnText, 'tingle-btn tingle-btn--primary tingle-btn--pull-right', function () {


				/* Start the chapter */
				if (stepIndex == gameData.revelations[chapterIndex].outro.length - 1) {

					modal.close();
					modal.destroy();

					chapterIndex++;
					if (chapterIndex == 4) { // TODO rimettere == 4, mettere > 0 per gli esperimenti
						$('#interrogation').prop('disabled', false);
					}

					if (chapterIndex == gameData.revelations.length) {
						createGameEndModal();
					}
					else {
						createNewChapterModal(0);

						/* Create new chapter revelation elements */
						addChapterRevelation();
					}
				}


				/* Next dialog line */
				else {
					stepIndex++;

					typewriter.deleteAll()
						.pauseFor(500)
						.typeString(gameData.revelations[chapterIndex].outro[stepIndex])
						.pauseFor(500)
						.start();

					if (stepIndex == gameData.revelations[chapterIndex].outro.length - 1) {
						document.getElementsByClassName('tingle-btn--pull-right')[0].innerHTML = 'Ok';
					}
				}
			});

			// open modal
			modal.open();

			// Typewriter text animation
			var app = document.getElementById('typewriter-text');

			var typewriter = new Typewriter(app, {
				loop: false,
				typingSpeed: 40,
				deleteSpeed: 0.01
			});

			typewriter.pauseFor(500)
				.typeString(gameData.revelations[chapterIndex].outro[stepIndex])
				.pauseFor(500)
				.start();

			return modal;
		}


		function createGameEndModal() {
			// instanciate new modal
			var modal = new tingle.modal({
				footer: true,
				stickyFooter: false,
				//closeMethods: ['overlay', 'button', 'escape'],
				//closeLabel: "Close",
				cssClass: [],
				onOpen: function () {
				},
				onClose: function () {
				},
				beforeClose: function () {
					return true; // close the modal
				}
			});

			// set content
			modal.setContent('<h1>' + gameData.endDialog.title + '</h1> <p>' + gameData.endDialog.text + '</p>');

			// add a button
			modal.addFooterBtn('Ok', 'tingle-btn tingle-btn--primary', function () {
				modal.close();
			});

			// open modal
			modal.open();

			return modal;
		}

		function createInterrogationAnswerModal(charId, questId) {

			/* stepIndex is the dialog line number */
			var stepIndex = 0;
			var btnText = '';

			// instanciate new modal
			var modal = new tingle.modal({
				footer: true,
				stickyFooter: false,
				closeMethods: ['button'],
				//closeLabel: "Close",
				cssClass: [],
				onOpen: function () {
				},
				onClose: function () {
				},
				beforeClose: function () {
					return true; // close the modal
				}
			});

			// set content
			var content = "";
			//content += '<h2>Chapter ' + gameData.revelations[chapterIndex].number + ' - ' + gameData.revelations[chapterIndex].title + '</h2>';
			if (charId == 3) {
				content += '<img class="detective-img" src="img/dhdtective.png"/>'
				questionStep = 4
			}
			else {
				content += '<img class="detective-img" src="img/Interrogatorio/' + characters[charId].image + '"/>';
			}
			content += '<p id="typewriter-text" class="dialog-text"></p>'
			modal.setContent(content);

			for (var i = 0; i < characters[charId].questions.length; i++) {
				if (characters[charId].questions[i].qId == questId) {
					break;
				}
			}

			if (stepIndex == characters[charId].questions[i].answer.length - 1) {
				btnText = 'Ok';
			}
			else {
				btnText = 'Next';
			}

			// add a button
			modal.addFooterBtn(btnText, 'tingle-btn tingle-btn--primary tingle-btn--pull-right', function () {

				/* Start the chapter */
				if (stepIndex == characters[charId].questions[i].answer.length - 1) {
					modal.close();
					modal.destroy();
					//$('#interrogationModal').modal("show");	
					if (questionStep == 3 && characters[i].name != 'Francesco Bonmartini' && lastQuestions['lindamurri'] && lastQuestions['augustomurri'] && lastQuestions['TullioMurri']) {
						createInterrogationAnswerModal(3, 4)
					}
					else if (questionStep < 4)
						interrogate(charId)
				}


				/* Next dialog line */
				else {
					stepIndex++;

					typewriter.deleteAll()
						.pauseFor(500)
						.typeString(characters[charId].questions[i].answer[stepIndex])
						.pauseFor(500)
						.start();

					if (stepIndex == characters[charId].questions[i].answer.length - 1) {
						document.getElementsByClassName('tingle-btn--pull-right')[0].innerHTML = 'Ok';
					}
				}
			});

			// open modal
			modal.open();

			// Typewriter text animation
			var app = document.getElementById('typewriter-text');

			var typewriter = new Typewriter(app, {
				loop: false,
				typingSpeed: 40,
				deleteSpeed: 0.01
			});

			typewriter.pauseFor(500)
				.typeString(characters[charId].questions[i].answer[stepIndex])
				.pauseFor(500)
				.start();

			return modal;
		}


		function changeMarkerContent(currentId, newId, posString, rotationString, scaleFactor, onclick, objPath, mtlPath) {
			var el = document.getElementById(currentId);
			el.id = newId;

			text = "";
			text += '<a-entity ';
			text += 'position="' + posString + '" ';
			text += 'rotation="' + rotationString + '" ';
			text += 'obj-model="obj: url(' + objPath + '); mtl: url(' + mtlPath + ')" ';
			text += 'scale="' + scaleFactor + ' ' + scaleFactor + ' ' + scaleFactor + '" ';
			text += 'onmousedown="' + onclick + '" ';
			text += '>';
			text += '<a-animation attribute="scale" begin="mousedown" dur="500" fill="backwards" to="' + scaleFactor / 2 + ' ' + scaleFactor / 2 + ' ' + scaleFactor / 2 + '"></a-animation>';
			text += '</a-entity>';

			el.innerHTML = text;
		}


		function insertMarker(id, marker, posString, rotationString, scaleFactor, onclick, objPath, mtlPath) {
			text = "";
			if (marker == "hiro" || marker == "kanji") {
				text += '<a-marker id="' + id + '" preset="' + marker + '" markername="' + marker + '">';
			}
			else {
				text += '<a-marker id="' + id + '" preset="custom" type="pattern" url="' + marker + '" markername="' + marker + '">';
			}

			// 3d Object
			if (mtlPath != null) {
				text += '<a-entity ';
				text += 'position="' + posString + '" ';
				text += 'rotation="' + rotationString + '" ';
				text += 'obj-model="obj: url(' + objPath + '); mtl: url(' + mtlPath + ')" ';
				text += 'scale="' + scaleFactor + ' ' + scaleFactor + ' ' + scaleFactor + '" ';
				text += 'onmousedown="' + onclick + '" ';
				text += '>';
			}

			// 3d Object
			else {
				text += '<a-image ';
				text += 'src="' + objPath + '" rotation="-90 0 0"';
				text += '>';
			}

			text += '<a-animation attribute="scale" begin="mousedown" dur="500" fill="backwards" to="' + scaleFactor / 2 + ' ' + scaleFactor / 2 + ' ' + scaleFactor / 2 + '"></a-animation>';
			
			if (mtlPath != null) {
				text += '</a-entity>';
			}
			else {
				text += '</a-image>';
			}

			text += '</a-marker>';


			var scene = document.getElementById('ascene');
			scene.insertAdjacentHTML('beforeend', text);
		}


		function handleRevelationCompleted(id) {

			createChapterEndModal();

			document.getElementById('clues').innerHTML = ""

			/* Fix every clue used to solve this chapter */
			var revel = document.getElementById(id).childNodes[1];
			for (var i = 0; i < revel.childNodes.length; i++) {
				if (revel.childNodes[i].classList.contains('dropzone')) {
					revel.childNodes[i].setAttribute('content', 'solved');
					revel.childNodes[i].childNodes[0].classList.remove('draggable');
					revel.childNodes[i].childNodes[0].id += '-solved-' + id;
				}
			}

			/* Reset clues icons */
			var oldClues = alreadyAddedClues;
			alreadyAddedClues = [];
			cluePositions.size = 0;

			for (var i = 0; i < oldClues.length; i++) {
				addClue(oldClues[i]);
			}

		}


		function setupChapterMarkers(chapter) {
			var markers = document.getElementsByTagName('a-marker');
			for (var j = 0; j < markers.length; j++) {
				markers[j].innerHTML = "";
			}

			for (var i = 0; i < gameData.revelations[chapter].activeClues.length; i++) {
				insertMarkerFromId(gameData.revelations[chapter].activeClues[i]);
			}
		}


		function insertMarkerFromId(id) {
			for (var i = 0; i < gameData.clues.length; i++) {
				if (gameData.clues[i].id == id) {

					var clue = gameData.clues[i];
					var markerIsUsed = false;

					var markers = document.getElementsByTagName('a-marker');
					for (var j = 0; j < markers.length; j++) {
						if (markers[j].getAttribute('markername') == clue.marker) {
							markerIsUsed = true;
							oldId = markers[j].id;
						}
					}

					if (!markerIsUsed) {
						insertMarker(
							'marker-' + clue.id,
							clue.marker,
							clue.posString,
							clue.rotationString,
							clue.scaleFactor,
							clue.function + "(\'" + clue.id + "\')",
							clue.obj,
							clue.mtl
						);
					}
					else {
						changeMarkerContent(
							oldId,
							'marker-' + clue.id,
							clue.posString,
							clue.rotationString,
							clue.scaleFactor,
							clue.function + "(\'" + clue.id + "\')",
							clue.obj,
							clue.mtl
						);
					}
				}
			}
		};





		/* Models Functions */
		var isAddModelCalled = false;
		function addModel(id) {
			/* Add option to select element */
			if (!isAddModelCalled) {
				isAddModelCalled = true;
				forceSelectModel(id);
			}
			document.getElementById("modelsframe").contentWindow.addIcon({ 'iconFilePath': 'iconselect/images/icons/' + id + '.png', 'iconValue': id })
		}

		function forceSelectModel(model) {
			console.log("Forcing select model " + model);
			document.getElementById('btn-models').style.visibility = "visible";
			modelsframe.getElementById('model-' + model).style.visibility = "visible";
			document.getElementById("modelsframe").contentWindow.currentModel = model;

			document.getElementById('clues').removeAttribute('data-step');
			document.getElementById('clues').removeAttribute('data-intro');

			document.getElementById('revelations').removeAttribute('data-step');
			document.getElementById('revelations').removeAttribute('data-intro');

			document.getElementById('btn-models').setAttribute('data-step', "1");
			document.getElementById('btn-models').setAttribute('data-intro', "This button opens the models section, where you can analyize discovered models.");
			setTimeout(function () {
				introJs().start();
			}, 300);
		}


		/* Spinner Picker Functions */
		var mobileSelect = new MobileSelect({
			trigger: '#mobileTrig',
			title: 'Lock',
			wheels: [
				{ data: ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'] },
				{ data: ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'] },
				{ data: ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'] },
				{ data: ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'] }
			],
			ensureBtnText: 'Confirm',
			cancelBtnText: 'Cancel',
			callback: function (indexArr, data) {
				console.log(data); //Returns the selected json data
				if (
					data[0] == '0' &&
					data[1] == '0' &&
					data[2] == '0' &&
					data[3] == '0'
				) {
					changeMarkerContent('marker-chest', 'marker-chest', '0 0.8 0.2', '90 180 0', 0.3, 'otherF',
						'models/Bauleaperto/Bauleapertocontexturefinal3.obj',
						'models/Bauleaperto/Bauleapertocontexturefinal3.mtl'
					);
					addClue('chest');
				}
			},
			triggerDisplayData: false,
			position: [0, 0, 0, 0] //Initialize positioning
		});

		function triggerMobileSelect(id) {
			setTimeout(function () {
				mobileSelect.show();
			}, 200);
		}

		function otherF(id) {
			console.log("aAAAAAAAAAA " + id);
		}

		function accuse(id) {
			cont = '<h3> Are you sure you want to accuse ' + characters[id].name + ' ? </h3></br>'
			cont += '<image class="charImg modalContens" src="./img/Interrogatorio/' + characters[id].image + '">'
			$("#yesBtn").attr("onclick", "yesAccuse(" + id + ")");
			$('#aysModalBody').html(cont);
			$('#characterModal').modal("hide");
			$('#aysModal').modal("show");
			

		}

		function yesAccuse(id) {
			console.log("accuso " + characters[id].name);
		}

		function tutorialClicked(id) {

			if (tutorialClick) {

				tutorialClick = false;

				document.getElementById('btn-clues').style.visibility = "visible";
				document.getElementById('btn-characters').style.visibility = "visible";

				document.getElementById('cursorTutorial').removeAttribute('data-step');
				document.getElementById('cursorTutorial').removeAttribute('data-intro');

				document.getElementById('btn-clues').setAttribute('data-step', "1");
				document.getElementById('btn-clues').setAttribute('data-intro', "This button opens the clues section, where you can make your hypothesis.");

				//document.getElementById('btn-models').setAttribute('data-step', "2");
				//document.getElementById('btn-models').setAttribute('data-intro', "This button opens the models section, where you can analyize discovered models.");

				document.getElementById('btn-characters').setAttribute('data-step', "2");
				document.getElementById('btn-characters').setAttribute('data-intro', "This button opens the characters section, where you can read info on the suspects.");

				addClue(id);

				setTimeout(function () { introJs().start(); }, 800);
			}
		}

		function interrogate(i) {
			console.log(characters[i].id)
			$('#characterModal').modal("hide");
			cont = '';
			cont += '<h3 class="modalContents" align="left">' + characters[i].name + ' <image class="interrogationImg modalContens"  src="./img/StoriaIniziale/' + characters[i].image + '"></h3> '
			// interrogazioni possibili
			$('#interrogationModalBody').html(cont);
			var options = "";
			for (var j = 0; j <= questionStep && j < characters[i].questions.length; j++) {
				if (characters[i].questions[j].qId <= questionStep) {
					options += "<option value='" + characters[i].questions[j].qId + "_" + i + "' class='questionOption'> " + characters[i].questions[j].question + "</option>"
				}
			}
			$('#questions').html(options);
			$("#ask").attr("onclick", "askQuestion(" + i + ",0)");
			//$('#ask').click(function(){askQuestion(i, 0)}); //indice del personaggio e 0 come prima domanda di default
			$('#interrogationModal').modal("show");
		}

		function askQuestion(charId, questId) { //char id = char index in the caracter json , quest id = qId
			console.log("ask")
			console.log(characters[charId].name);
			console.log(questId);
			for (var i = 0; i < characters[charId].questions.length; i++) {
				if (characters[charId].questions[i].qId == questId) {
					break;
				}
			}
			if (characters[charId].questions[i].unlock.length > 0) {
				if (questionStep < characters[charId].questions[i].unlock[0].qId)
					questionStep = characters[charId].questions[i].unlock[0].qId;
				console.log(questionStep);
			}
			if (questId == 3 && (characters[charId].id == 'lindamurri' || characters[charId].id == 'augustomurri' || characters[charId].id == 'TullioMurri')) {
				lastQuestions[characters[charId].id] = 1;
			}
			$('#interrogationModal').modal("hide");
			//parte il dialogo con la risposta 
			createInterrogationAnswerModal(charId, questId);

		}


		/* Init variables */
		var cluesVisible = false;
		var modelsVisible = false;
		var startPos = { x: 0, y: 0 };
		var chapterIndex = 0;
		var discovered = {}
		var tutorialClues = true;
		var tutorialClick = true;
		var questionStep = 0;
		window.onload = function () {
			modelsframe = document.getElementById('modelsframe').contentWindow.document;
			initCharacters();
		}

		var cluePositions = {};
		cluePositions.size = 0;
		cluePositions.list = [];
		var lastQuestions = {
			'lindamurri': 0,
			'augustomurri': 0,
			'TullioMurri': 0,
		}

		/* Insert clues to fill cluePosition struct */
		for (i = 0; i < gameData.clues.length; i++) {
			addClueSetup(gameData.clues[i].id);
		}
		/* Empty clues div */
		document.getElementById('clues').innerHTML = "";

		/* Insert clues */
		/*for (i = 0; i < gameData.clues.length; i++) {
			addClue(gameData.clues[i].id);
		}*/

		/* Insert revelations/dropzones */
		addChapterRevelation();

		/* Activate drag and drop */
		activateDropzones();
		activateDraggableClues();


		modal = createInitialModal();
		/*$('.clickableModal').click(function (){
			modal.close();
			modal.destroy();
			createNewChapterModal(0);
		})*/
		//addClue('window');
		//addClue('key');
		//addClue('lock');
		$('#questions').change(function () {
			val = $('#questions').val()
			var q = val.substr(0, val.indexOf('_'));
			var c = val.substr(val.indexOf('_') + 1, val.length);
			console.log($('#questions').val())
			//$('#ask').click(function(){askQuestion(c, q)})
			$("#ask").attr("onclick", "askQuestion(" + c + "," + q + ")");

		})
	</script>

</body>

</html>